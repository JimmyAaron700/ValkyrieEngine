# import time
import erp_construction_bidding  # å¯¼å…¥æ¨¡å—äºŒï¼Œä¸ºäº†å¤ç”¨å®ƒçš„â€œé‡ç½®å›é¦–é¡µâ€åŠŸèƒ½


def get_empty_record(code, status):
    """
    ç§¯æœ¨å— Fï¼šç”Ÿæˆæ ‡å‡†æ•°æ®æ¨¡æ¿
    åŠŸèƒ½ï¼šæ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½å¿…é¡»è¿”å›åŒ…å«æ‰€æœ‰å­—æ®µçš„å­—å…¸ï¼Œé˜²æ­¢å†™å…¥ Excel æ—¶åˆ—é”™ä½ã€‚
    """
    return {
        "é¡¹ç›®ç¼–å·": code,
        "é¡¹ç›®åç§°": 0,
        "é¡¹ç›®å·¥ç¨‹æ€»é€ ä»·(å…ƒ)": 0,
        "å¸‚æ”¿é“è·¯ä¿®å¤è´¹": 0,
        "å°åŒºé“è·¯ä¿®å¤è´¹": 0,
        "ç»¿åŒ–ä¿®å¤è´¹": 0,
        "å‘åŒ…é‡‘é¢": 0,
        "æ‰“æ†æ‹›æ ‡åç§°": 0,
        "é¡¹ç›®ä¸­æ ‡é‡‘é¢": 0,
        "çŠ¶æ€": status
    }


def extract_detail_data(detail_tab, code):
    """
    ç§¯æœ¨å— Gï¼šè¯¦æƒ…é¡µç²¾å‡†æŠ“å– (V3 ç»ˆæå…¼å®¹ç‰ˆ)
    åŠŸèƒ½ï¼šæ”¾å®½å³ä¾§æ ¼å­çš„åŒ¹é…æ¡ä»¶ï¼Œåº”å¯¹ ERP ç½‘é¡µå‰ç«¯ä»£ç ä¸è§„èŒƒçš„é—®é¢˜ã€‚
    """
    print(f"      -> æ­£åœ¨æå– [{code}] çš„è¯¦ç»†èµ„é‡‘æ•°æ®...")

    record = get_empty_record(code, "å®Œæˆ")
    detail_tab.wait(2)

    fields_to_extract = [
        "é¡¹ç›®åç§°", "é¡¹ç›®å·¥ç¨‹æ€»é€ ä»·(å…ƒ)", "å¸‚æ”¿é“è·¯ä¿®å¤è´¹",
        "å°åŒºé“è·¯ä¿®å¤è´¹", "ç»¿åŒ–ä¿®å¤è´¹", "å‘åŒ…é‡‘é¢",
        "æ‰“æ†æ‹›æ ‡åç§°", "é¡¹ç›®ä¸­æ ‡é‡‘é¢"
    ]

    for field in fields_to_extract:
        try:
            # ç»æ‹› 1ï¼šå·¦è¾¹å®šä½ä¾ç„¶ä¸¥è°¨ (åªæ‰¾ç©¿ td_normal_title åˆ¶æœçš„æ ‡é¢˜æ ¼)
            label_td = detail_tab.ele(f'tag:td@@class=td_normal_title@@text():{field}', timeout=3)

            # ç»æ‹› 2ï¼šã€æ ¸å¿ƒä¿®å¤ã€‘å³è¾¹å®šä½æ”¾å®½ï¼
            # å»æ‰äº† @@class=tb_normalã€‚æ„æ€æ˜¯ï¼šä¸ç®¡ä½ ç©¿å•¥è¡£æœï¼Œåªè¦ä½ æ˜¯ç´§è·Ÿç€æ ‡é¢˜çš„ä¸‹ä¸€ä¸ª td æ ¼å­ï¼Œæˆ‘å°±æŠ“ä½ ï¼
            value_td = label_td.next('tag:td')

            # æŠŠå³æ ¼å­é‡Œçš„åŸå§‹æ–‡æœ¬æ‹¿å‡ºæ¥
            raw_text = value_td.text

            # ç»æ‹› 3ï¼šæ•°æ®æ¸…æ´—æœº
            clean_text = raw_text.replace('\n', '').replace('\t', '').strip()

            record[field] = clean_text

        except Exception as e:
            # ä¸‡ä¸€ä»¥åè¿˜æœ‰å¹ºè›¾å­ï¼Œæˆ‘ä»¬æŠŠå…·ä½“æ˜¯å“ªä¸ªå­—æ®µæŠ¥é”™æ‰“å°å‡ºæ¥ï¼Œæ–¹ä¾¿è¿½æ€
            print(f"      âš ï¸ [è­¦å‘Š] æ‰¾ä¸åˆ°å­—æ®µ: {field}")
            record[field] = "æŠ“å–å¼‚å¸¸"
            record["çŠ¶æ€"] = "éƒ¨åˆ†å­—æ®µå¼‚å¸¸"

    return record


def search_and_process_single(page, search_tab, code):
    """
    ç§¯æœ¨å— Hï¼šå•æ¬¡æœç´¢ä¸è£åˆ¤ä¸­å¿ƒ (V2 å¾ªç¯ä¿®å¤ç‰ˆ)
    åŠŸèƒ½ï¼šæ‰§è¡Œæœç´¢å‰å…ˆæ¸…ç†æ—§æ ‡ç­¾ï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ˜¯å¹²å‡€çš„æœç´¢ã€‚
    """
    try:
        # === ç»æ‹› 1ï¼šæ‰“æ‰«æˆ˜åœºï¼ˆä¸“æ²»å¾ªç¯å¡æ­»ï¼‰ ===
        # æ¢æŸ¥é¡µé¢ä¸Šæœ‰æ²¡æœ‰ä¸Šä¸€æ¬¡æœç´¢é—ç•™çš„â€œä¸»é¢˜: Dxxxâ€æ ‡ç­¾
        # æ³¨æ„è¿™é‡Œçš„å†’å·æ˜¯å…³é”®ï¼Œå®ƒèƒ½ç²¾å‡†é¿å¼€è¡¨æ ¼è¡¨å¤´çš„â€œä¸»é¢˜â€ä¸¤å­—
        old_tag = search_tab.ele('text:ä¸»é¢˜:', timeout=2)

        if old_tag:
            print("   >>> å‘ç°ä¸Šä¸€æ¬¡æœç´¢æ®‹ç•™çš„æ ‡ç­¾ï¼Œæ­£åœ¨ç‚¹å‡» [X] æ¸…é™¤...")
            # æ‰¾åˆ°æ ‡ç­¾æ–‡æœ¬åï¼Œå¾€ä¸Šæ‰¾ä¸€å±‚çˆ¶ç›’å­ï¼ˆé€šå¸¸æ˜¯ <a> æˆ– <li>ï¼‰ï¼Œç„¶åç‚¹å‡»ç›’å­é‡Œçš„å‰å‰
            try:
                old_tag.parent().ele('@class=cancel').click()
            except:
                # ä¸‡ä¸€ç»“æ„å˜äº†ï¼Œä½œä¸ºå¤‡ç”¨æ‰‹æ®µï¼Œç›´æ¥ç‚¹å‡»å®ƒå³è¾¹æŒ¨ç€çš„å…ƒç´ 
                old_tag.next().click()

            # æ‹”æ‰æ ‡ç­¾åï¼Œç³»ç»Ÿä¼šå±€éƒ¨åˆ·æ–°ï¼ŒæŠŠçœŸæ­£çš„æœç´¢æ¡†åå‡ºæ¥ï¼Œè¿™é‡Œå¼ºåˆ¶ç­‰ 2 ç§’è®©å­å¼¹é£ä¸€ä¼šå„¿
            search_tab.wait(2)

        # === ç»æ‹› 2ï¼šåŒä¿é™©å®šä½è¾“å…¥æ¡† ===
        # é¦–é€‰ï¼šåˆ©ç”¨ä½ å‘æˆ‘çš„åº•å±‚ä»£ç ï¼Œç”¨ data-lui-placeholder é”šå®šï¼Œè¿™ä¸ªå±æ€§æœ€ç¨³
        search_box = search_tab.ele('@data-lui-placeholder=è¯·è¾“å…¥ä¸»é¢˜', timeout=10)

        # å¤‡é€‰ï¼šå¦‚æœåº•å±‚å±æ€§çœŸè¢«ç³»ç»Ÿåˆ äº†ï¼Œç”¨æœ€åŸå§‹çš„ placeholder å…œåº•
        if not search_box:
            search_box = search_tab.ele('@placeholder=è¯·è¾“å…¥ä¸»é¢˜', timeout=10)

        # å…ˆæ¸…ç©ºæ¡†ï¼ˆé˜²ä¸‡ä¸€ï¼‰ï¼Œå†è¾“å…¥æ–°ç¼–å·ï¼Œé™„å¸¦ \n å›è½¦
        search_box.clear().input(f'{code}\n')

        print(f"   >>> æ­£åœ¨æœç´¢ [{code}]ï¼Œç­‰å¾…ç³»ç»ŸåŠ è½½...")
        search_tab.wait(4)

        # === ä¸‹é¢çš„è£åˆ¤å’Œæå–é€»è¾‘ä¿æŒå®Œå…¨ä¸å˜ ===
        results = search_tab.eles(f'text:{code}-')
        result_count = len(results)

        if result_count == 0:
            print(f"   [åˆ¤å®š] æœç´¢ä¸åˆ°è®°å½•ï¼Œæ ‡è®°ä¸ºï¼šæœªå‘åŒ…")
            return get_empty_record(code, "æœªå‘åŒ…")

        elif result_count > 1:
            print(f"   [åˆ¤å®š] æ‰¾åˆ° {result_count} æ¡è®°å½•ï¼Œä¸ºé˜²è¯¯ç‚¹ï¼Œæ ‡è®°ä¸ºï¼šå¾…ç¡®è®¤")
            return get_empty_record(code, "å¾…ç¡®è®¤")

        else:
            print(f"   [åˆ¤å®š] ç²¾ç¡®å‘½ä¸­ 1 æ¡è®°å½•ï¼Œå‡†å¤‡æ½œå…¥æå–...")
            results[0].click()

            detail_tab = page.latest_tab
            final_record = extract_detail_data(detail_tab, code)
            detail_tab.close()

            return final_record

    except Exception as e:
        print(f"   âš ï¸ ä¸¥é‡è­¦å‘Šï¼šå¤„ç† [{code}] æ—¶ç½‘é¡µå¡æ­»æˆ–å´©æºƒï¼é”™è¯¯ä¿¡æ¯ï¼š{e}")
        raise Exception("SearchTimeout")


def run_data_cycle(page, search_tab, codes_list):
    """
    ç§¯æœ¨å— Iï¼šæ”¶å‰²å¤§å¾ªç¯ (ä¸»æ§ä¸­å¿ƒ)
    åŠŸèƒ½ï¼šéå†æ‰€æœ‰ç¼–å·ï¼Œå¹¶é™„å¸¦ç»ˆæçœ‹é—¨ç‹—è‡ªæ„ˆæœºåˆ¶ã€‚
    """
    total = len(codes_list)
    all_results = []

    for index, code in enumerate(codes_list, start=1):
        print(f"\nâ–¶ï¸ è¿›åº¦ [{index}/{total}] å¼€å§‹å¤„ç†ç¼–å·: {code}")

        max_retries = 2  # å¦‚æœæŸä¸ªç¼–å·å¡æ­»ï¼Œæœ€å¤šç»™å®ƒ 2 æ¬¡é‡æ–°æŠ¢æ•‘çš„æœºä¼š

        for attempt in range(1, max_retries + 1):
            try:
                # å°è¯•å¤„ç†å•ä¸ªç¼–å·
                record = search_and_process_single(page, search_tab, code)
                all_results.append(record)

                # æ‰“å°å•æ¡ç»“æœä¾›ä½ ç›‘æ§
                print(f"   âœ… å®Œæˆå­—å…¸å†…å®¹: {record}")
                break  # æˆåŠŸäº†å°±è·³å‡ºé‡è¯•å¾ªç¯ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªç¼–å·

            except Exception as e:
                # æ•è·åˆ°äº† search_and_process_single æ‰”å‡ºæ¥çš„ "SearchTimeout"
                print(f"   ğŸ”„ [ç¬¬ {attempt} æ¬¡æ€¥æ•‘] è§¦å‘ç½‘é¡µé‡ç½®ç¨‹åº...")

                if attempt < max_retries:
                    # 1. è°ƒç”¨æ¨¡å—äºŒçš„ç§¯æœ¨å—ï¼Œå…³æ‰æ‰€æœ‰ä¹±ä¸ƒå…«ç³Ÿçš„é¡µé¢ï¼Œåˆ·æ–°é¦–é¡µ
                    erp_construction_bidding.reset_and_back_to_home(page)
                    # 2. é‡æ–°èµ°ä¸€éç‚¹å‡»â€œæµç¨‹æŸ¥è¯¢â€ã€â€œæ–½å·¥å§”æ‰˜â€ã€â€œç‚¹é€‰ç»“æŸâ€çš„æµç¨‹
                    search_tab = erp_construction_bidding.setup_search_environment(page)
                    print(f"   >>> ç½‘é¡µé‡ç½®å®Œæ¯•ï¼Œå‡†å¤‡å¯¹ [{code}] é‡æ–°å‘èµ·æœç´¢...")
                else:
                    # é‡è¯•äº†è¿˜æ˜¯ä¸è¡Œï¼Œè¯´æ˜è¿™ä¸ªç¼–å·æ˜¯ä¸ªæ¯’ç˜¤ï¼Œæˆ–è€…é›†å›¢ç½‘å½»åº•æ–­äº†
                    print(f"   âŒ æ”¾å¼ƒæŠ¢æ•‘ï¼š[{code}] å¯¼è‡´ç¨‹åºåå¤å¡æ­»ã€‚")
                    # è®°ä¸ºé”™è¯¯ï¼Œä¸å½±å“åé¢çš„ç¼–å·
                    all_results.append(get_empty_record(code, "ç½‘é¡µè¿ç»­å¡æ­»å¤±è´¥"))

    return all_results


# ---------------- å•ç‹¬æµ‹è¯•åŒº ----------------
if __name__ == '__main__':
    from DrissionPage import ChromiumPage

    print("====== æ¨¡å—ä¸‰ç‹¬ç«‹æµ‹è¯•å¯åŠ¨ ======")
    print("è¯·ç¡®ä¿ä½ ç°åœ¨å·²ç»æ‰‹åŠ¨æ‰“å¼€äº† ERPï¼Œå¹¶ä¸”é¡µé¢åœç•™åœ¨ã€å·²ç»è®¾ç½®å¥½ç»“æŸå’Œæ—¶é—´æ¡ä»¶ã€‘çš„æœç´¢ç•Œé¢ï¼")
    input("å‡†å¤‡å¥½äº†è¯·æŒ‰å›è½¦ç»§ç»­...")

    # å¼ºè¡Œæ¥ç®¡ä½ å½“å‰æ­£åœ¨çœ‹çš„é‚£ä¸ªæµè§ˆå™¨
    page = ChromiumPage()
    # å› ä¸ºä½ å½“å‰å°±åœ¨æœç´¢é¡µï¼Œæ‰€ä»¥ search_tab å°±æ˜¯ page æœ¬èº«æ‰€åœ¨çš„é¡µé¢
    current_search_tab = page

    # æ¨¡æ‹Ÿå‡ ä¸ªæµ‹è¯•ç¼–å· (ä½ å¯ä»¥æ”¹æˆä½ ä»¬ç³»ç»Ÿé‡ŒçœŸå®çš„ç¼–å·æ¥æµ‹è¯•)
    test_codes = [
        "D1251420211",  # å‡è®¾è¿™æ˜¯æˆªå›¾é‡Œé‚£ä¸ªå®Œç¾çš„å•æ¡è®°å½•
        "D9999999999",  # å‡è®¾è¿™æ˜¯ä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„ç¼–å· (æµ‹è¯•æœªå‘åŒ…)
        "D1251420013"  # å‡è®¾è¿™æ˜¯å¦ä¸€ä¸ªæ­£å¸¸ç¼–å·
    ]

    # å¯åŠ¨å¾ªç¯è½°ç‚¸
    final_data = run_data_cycle(page, current_search_tab, test_codes)

    print("\nğŸ‰ æµ‹è¯•ç»“æŸï¼Œæœ€ç»ˆæ±‡æ€»çš„å­—å…¸åˆ—è¡¨å¦‚ä¸‹ï¼š")
    for data in final_data:
        print(data)